---
# 1. Détermination de l'IP cible
- name: Identify target IP (same or new)
  set_fact:
    target_ip: "{{ ansible_default_ipv4.address if hypervisor_ip == 'same' else hypervisor_ip }}"

- name: Debug target IP
  debug:
    msg: "Transitioning cloudbr0 to Static IP: {{ target_ip }}"

# 2. Configuration de cloudbr0 via nmcli
# On utilise le module nmcli pour configurer les paramètres (sans redémarrer l'interface encore)
- name: Configure cloudbr0 parameters (Static mode)
  nmcli:
    conn_name: "cloudbr0"
    ifname: "cloudbr0"
    type: bridge
    ip4: "{{ target_ip }}/{{ netmask_prefix }}"
    gw4: "{{ gateway }}"
    dns4: "{{ dns_server }}"
    method4: "manual"
    state: present

# 3. Application du changement
# Si l'IP change, Ansible va perdre la connexion. On lance le restart en tâche de fond.
- name: Apply network changes and restart cloudbr0
  shell: "sleep 2 && nmcli con up cloudbr0"
  async: 20
  poll: 0
  register: network_restart

- name: Wait for connection to stabilize
  wait_for_connection:
    connect_timeout: 10
    sleep: 5
    timeout: 30
  when: hypervisor_ip == 'same'

# 4. Cas particulier : Mise à jour de l'IP dans la mémoire d'Ansible
- name: Update Ansible host if IP has changed
  set_fact:
    ansible_host: "{{ target_ip }}"
  when: hypervisor_ip != 'same'
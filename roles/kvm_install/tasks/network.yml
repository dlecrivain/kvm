---
# Identify current IP if 'same' is requested
- name: Get current IP address
  set_fact:
    target_ip: "{{ ansible_default_ipv4.address }}"
  when: hypervisor_ip == "same"

- name: Set target IP from variable
  set_fact:
    target_ip: "{{ hypervisor_ip }}"
  when: hypervisor_ip != "same"

- name: Apply IP configuration to existing cloudbr0
  nmcli:
    conn_name: "cloudbr0"
    ifname: "cloudbr0"
    type: bridge
    ip4: "{{ target_ip }}/{{ netmask_prefix }}"
    gw4: "{{ gateway }}"
    dns4: "{{ dns_server }}"
    state: present
  register: nmcli_result

- name: Restart cloudbr0 to apply changes
  shell: "nmcli con up cloudbr0"
  when: nmcli_result.changed
---
- name: Identify target IP (same or new)
  set_fact:
    target_ip: "{{ ansible_default_ipv4.address if hypervisor_ip == 'same' else hypervisor_ip }}"

- name: Configure cloudbr0 parameters (Static mode)
  nmcli:
    conn_name: "cloudbr0"
    ifname: "cloudbr0"
    type: bridge
    ip4: "{{ target_ip }}/{{ netmask_prefix }}"
    gw4: "{{ gateway }}"
    dns4: "{{ dns_server }}"
    method4: "manual"
    state: present

- name: Apply network changes and restart cloudbr0
  shell: "sleep 2 && nmcli con up cloudbr0"
  async: 20
  poll: 0

- name: Wait for connection to stabilize
  wait_for_connection:
    delay: 5
    timeout: 30
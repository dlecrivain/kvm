---
# Main setup for KVM Hypervisor on AlmaLinux
- name: Ensure domain_name is specified
  fail:
    msg: "Please specify a domain_name using -e 'domain_name=xxx'"
  when: domain_name is not defined or domain_name == "local.lab"

- name: Install Virtualization group and management tools
  dnf:
    name:
      - "@Virtualization Host"
      - virt-install
      - virt-viewer
      - libguestfs-tools
    state: present

- name: Enable and start libvirtd service
  systemd:
    name: libvirtd
    state: started
    enabled: yes

- name: Detect CPU vendor and load appropriate KVM module
  block:
    - name: Set KVM module name based on CPU vendor facts
      set_fact:
        kvm_module: >-
          {% if 'GenuineIntel' in ansible_processor or 'Intel' in ansible_processor_common_name | default('') %}
          kvm_intel
          {% elif 'AuthenticAMD' in ansible_processor or 'AMD' in ansible_processor_common_name | default('') %}
          kvm_amd
          {% else %}
          {% endif %}

    - name: Fallback to manual check if vendor is still unknown
      shell: "grep -q vmx /proc/cpuinfo && echo 'kvm_intel' || (grep -q svm /proc/cpuinfo && echo 'kvm_amd' || echo '')"
      register: cpu_shell_check
      changed_when: false
      when: kvm_module == ""

    - name: Update kvm_module from shell check
      set_fact:
        kvm_module: "{{ cpu_shell_check.stdout }}"
      when: kvm_module == "" and cpu_shell_check.stdout is defined

    - name: Load common KVM kernel module
      modprobe:
        name: kvm
        state: present

    - name: Load vendor-specific KVM module
      modprobe:
        name: "{{ kvm_module }}"
        state: present
      when: kvm_module != ""

- name: Configure Firewalld to allow virtualization traffic
  firewalld:
    service: libvirt
    permanent: yes
    state: enabled
    immediate: yes

- name: Optimize system performance for virtualization using tuned
  block:
    - name: Install tuned package
      dnf:
        name: tuned
        state: present

    - name: Apply virtual-host tuned profile
      command: tuned-adm profile virtual-host
      register: tuned_result
      changed_when: "'Current active profile: virtual-host' not in tuned_result.stdout"

- name: Validate virtualization capabilities
  command: virt-host-validate qemu
  register: virt_val
  ignore_errors: yes
  changed_when: false

- name: Report validation status
  debug:
    msg: "KVM Validation failed! Check BIOS/VT-x settings."
  when: virt_val.rc != 0

# --- ALWAYS KEEP NETWORK AT THE END ---
- name: Handle Network configuration
  include_tasks: network.yml